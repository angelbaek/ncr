<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <!-- test css -->
  <link rel="stylesheet" href="/static/css/common.css" />
  <link rel="stylesheet" href="/static/css/admin_exam_management.css" />
  <!-- common css -->
  <link rel="stylesheet" href="/css/common.css" />
  <link rel="stylesheet" href="/css/admin_exam_management.css" />
  <!-- font awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css"
  />
  <body>
    <div class="left_nav">
      <div class="nav_title">
        <a href="/">국가기간망<br />침투대응훈련</a>
      </div>
      <div class="nav_contents">
        <div class="common_left_menubar">
          <a href="admin_training" id="only_css">훈련 관리</a>
        </div>
        <div
          class="common_left_menubar"
          id="left_menubar"
          onclick="dropdownMenu()"
        >
          문제 관리
          <i class="fas fa-caret-down" id="dropbox_ic"></i>
          <ul class="dropdown">
            <li><a href="admin_exam_group">문제 그룹</a></li>
            <li>
              <a class="exam_manage_css" href="admin_exam_management"
                >문항 관리</a
              >
            </li>
          </ul>
        </div>
        <div class="common_left_menubar" id="only_css">
          <a href="admin_exam_explanation">문제 풀이</a>
        </div>
        <div class="common_left_menubar" id="only_css">
          <a href="admin_exam_result">결과 보기</a>
        </div>
      </div>
    </div>
    <div class="top_user_info">
      <div class="contents_title">문항 관리</div>
      <div class="top_user_info_div" onclick="showLogOutBtn()">
        <img src="/public/images/avatar-4.png" alt="user" />
        <div class="userName">User Name</div>
        <i class="fas fa-caret-down" id="logout"></i>
        <div class="logout_btn" onclick="logOut()">
          <div class="user_teamcode_view">팀코드</div>
          <div class="user_logout_btn">로그아웃</div>
        </div>
      </div>
    </div>
    <!-- 문제 그룹 -->
    <div class="contents">
      <div class="contents_title_top">
        <div class="contents_title_grp_name">문제 그룹명</div>
        <select
          name="grp_name"
          id=""
          class="select_view_body"
          onchange="selectGrpChange()"
        >
          <option value="">직접선택</option>
        </select>
        <button class="exam_upload" onclick="popup_exam_popupStatus()">
          문제 업로드
        </button>
      </div>
      <div class="exam_table">
        <table>
          <tbody class="tr_add">
            <tr></tr>
          </tbody>
        </table>
      </div>
      <div class="exam_answer">
        <div class="exam_answer_div">
          <div class="exam_answer_div_div">
            <div class="exam_answer_title">문제</div>
            <input class="exam_answer_title_const" type="text" />
          </div>
          <div class="answer_input_text">
            문제유형 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;문제보기
          </div>
          <div class="test">
            <div class="slice_box1">
              <div class="exam_answer_common_text">
                <input
                  type="radio"
                  class="common_check"
                  value="1"
                  id="exam-type1"
                  name="double"
                />
                <div class="exam_answer_common_text_check" id="only_css_check">
                  객관식
                </div>
              </div>
              <div class="exam_answer_common_text" id="left_call_div">
                <input
                  type="radio"
                  class="common_check"
                  value="2"
                  id="exam-type2"
                  name="double"
                />
                <div class="exam_answer_common_text_check">단답형</div>
              </div>
            </div>
            <div class="slice_box2">
              <div class="exam_answer_common_text">
                <div>1번</div>
                <input type="text" maxlength="255" class="tr_exam_choice_1" />
              </div>
              <div class="exam_answer_common_text">
                <div>2번</div>
                <input type="text" maxlength="255" class="tr_exam_choice_2" />
              </div>
              <div class="exam_answer_common_text">
                <div>3번</div>
                <input type="text" maxlength="255" class="tr_exam_choice_3" />
              </div>
              <div class="exam_answer_common_text">
                <div>4번</div>
                <input type="text" maxlength="255" class="tr_exam_choice_4" />
              </div>
              <br />
              <div class="exam_answer_common_text">
                <div>5번</div>
                <input type="text" maxlength="255" class="tr_exam_choice_5" />
              </div>
            </div>
          </div>
          <div class="dandap_import_text">정답 입력</div>
          <div class="test">
            <div class="left_input_call">
              <input type="text" maxlength="255" class="tr_exam_ans" />
            </div>
          </div>
          <div class="bottom">
            <div class="bottom_div">
              <div class="common_level_div">
                <div class="">난이도 설정</div>
                <div class="">
                  <input
                    type="radio"
                    name="trio"
                    id="tr_exam_level1"
                    value="1"
                  />
                  <p>상</p>
                  <input
                    type="radio"
                    name="trio"
                    id="tr_exam_level2"
                    value="2"
                  />
                  <p>중</p>
                  <input
                    type="radio"
                    name="trio"
                    id="tr_exam_level3"
                    value="3"
                  />
                  <p>하</p>
                </div>
              </div>
              <div class="common_level_div">
                <input class="tr_exam_mult_ans" type="checkbox" />
                <p>복수 정답 허용</p>
              </div>
              <div class="common_level_div">
                <button onclick="popup_hint_popupStatus()">힌트 설정</button>
                <button onclick="popup_mit_popupStatus()">
                  MITER ATTACK 정보 입력
                </button>
              </div>
            </div>
          </div>
          <div class="setup_div">
            <button onclick="resetExam()">초기화</button>
            <button onclick="examFinalSave()">저장</button>
          </div>
        </div>
      </div>
    </div>
    <!-- 힌트 div -->
    <div class="popup_hint">
      <div class="popup_hint_txt">힌트 내용</div>
      <input class="hint_input" type="text" />
      <div class="popup_hint_txt">힌트 파일 첨부</div>
      <!-- <input name="uploadFiles" type="file" id="hint_file" /> -->
      <form id="fileUploadForm" enctype="multipart/form-data">
        <input type="file" id="fileInput" name="fileInput" />
        <!-- <button type="submit">Upload</button> -->
      </form>
      <div>
        <button class="uploadBtn" onclick="updateHint()">확인</button>
        <button onclick="popup_hint_popupStatusOff()">취소</button>
      </div>
    </div>
    <!-- 문제 업로드 div -->
    <div class="popup_exam">
      <div class="popup_exam_txt">문제 파일 첨부</div>
      <input type="file" name="file" id="exam_file" accept=".csv" />
      <div>
        <button onclick="testing()">확인</button>
        <button onclick="popup_exam_popupStatusOff()">취소</button>
      </div>
    </div>
    <!-- MITER ATTACK div -->
    <div class="popup_mit">
      <div class="popup_mit_txt">MITER ATTACK 정보</div>
      <div>
        <select class="tactics_select" name="" id="">
          <option value="">tatic</option>
        </select>
        <select class="matrix_select" name="" id="">
          <option value="">tach</option>
        </select>
      </div>
      <div>
        <button onclick="tacticsSave()">확인</button>
        <button onclick="popup_mit_popupStatus_cancel()">취소</button>
      </div>
    </div>
    <!-- 백그라운드 -->
    <div class="back"></div>
  </body>
  <script
    src="https://code.jquery.com/jquery-3.6.3.js"
    integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM="
    crossorigin="anonymous"
  ></script>
  <script src="jquery-csv.js"></script>
  <script src="/static/js/common.js"></script>
  <script src="/js/common.js"></script>
  <script src="/static/js/admin_exam_management.js"></script>
  <script src="/js/admin_exam_management.js"></script>
  <script>
    // 팝업창 안보이게
    $(".popup_hint").css("display", "none");
    $(".popup_exam").css("display", "none");
    $(".popup_mit").css("display", "none");
    $(".back").css("display", "none");
    // $(".exam_add").css("display", "none");
    // 좌측 nav menu
    $(".dropdown").css("display", "block");
    //객관식 활성화 함수
    function choiceOn() {
      $(".tr_exam_choice_1").prop("disabled", false);
      $(".tr_exam_choice_2").prop("disabled", false);
      $(".tr_exam_choice_3").prop("disabled", false);
      $(".tr_exam_choice_4").prop("disabled", false);
      $(".tr_exam_choice_5").prop("disabled", false);
      $(".tr_exam_choice_1").css("backgroundColor", "white");
      $(".tr_exam_choice_2").css("backgroundColor", "white");
      $(".tr_exam_choice_3").css("backgroundColor", "white");
      $(".tr_exam_choice_4").css("backgroundColor", "white");
      $(".tr_exam_choice_5").css("backgroundColor", "white");
    }
    //객관식 비활성화 함수
    function choiceOff() {
      $(".tr_exam_choice_1").prop("disabled", true);
      $(".tr_exam_choice_2").prop("disabled", true);
      $(".tr_exam_choice_3").prop("disabled", true);
      $(".tr_exam_choice_4").prop("disabled", true);
      $(".tr_exam_choice_5").prop("disabled", true);
      $(".tr_exam_choice_1").css("backgroundColor", "#cccccc");
      $(".tr_exam_choice_2").css("backgroundColor", "#cccccc");
      $(".tr_exam_choice_3").css("backgroundColor", "#cccccc");
      $(".tr_exam_choice_4").css("backgroundColor", "#cccccc");
      $(".tr_exam_choice_5").css("backgroundColor", "#cccccc");
    }
    choiceOff();

    $("#dropbox_ic").css("transform", "rotate(180deg)");

    // 라디오 버튼 감지
    $("input[name='double']").change(function () {
      var test = $("input[name='double']:checked").val();
      if (test == 1) {
        choiceOn();
      } else if (test == 2) {
        choiceOff();
      }
    });
  </script>
  <script>
    var file;
    var count = 0;
    document.getElementById("exam_file").onchange = function () {
      // 파일
      file = this.files[0];
    };
    function testing() {
      if (file == undefined) {
        alert("csv파일을 선택하세요.");
        $("#exam_file").focus();
        return;
      }
      // 문제 그룹명
      var grpName = $(".select_view_body option:selected").text();
      if (confirm(grpName + " 문제 그룹을 업로드 하시겠습니까?")) {
        // 문제 그룹 id
        var grpid = $(".select_view_body option:selected").val();
        file;
        // 파일 읽기
        var reader = new FileReader();
        reader.onload = function (progressEvent) {
          // 여기에 길이 함수 맞추자
          let examLength = getExamLength();
          // console.log(examLength);
          // Entire file
          // console.log(this.result);
          // By lines
          var lines = this.result.split("\n");
          // 조건식 +2한 이유는 기본 줄 수에서 +2됨
          // console.log("줄수:" + lines.length);
          if (examLength + 2 < lines.length) {
            alert("CSV파일의 문항수를 확인하세요");
            return;
          }
          for (var line = 1; line < lines.length; line++) {
            // console.log("포함?" + lines[line].includes('"'));
            // console.log("길이:" + lines.length);
            if (lines[line].indexOf('"') != -1) {
              // console.log("포함됨");
              var start = lines[line].indexOf('"');
              // 첫번째 " 자름
              var substr = lines[line].substr(start + 1, lines[line].length);
              var end = substr.indexOf('"');
              // 두번째 " 자름
              var twoSubstr = substr.substr(0, end); // 정답
              var sl = twoSubstr.split(",");
              var leng = sl.length - 1;
              // console.log("몇번 자름?:" + leng);
              // console.log(twoSubstr);
              // 여기까지가 구하는 식
              var str = lines[line].split(",");
              // console.log(str);
              // 문제 번호
              var exam_num = str[0];
              // 문제 유형
              var exam_type = str[1];
              // 문제 내용
              var exam_cont = str[2];
              // 객관식_번호
              var exam_cho1 = str[3];
              var exam_cho2 = str[4];
              var exam_cho3 = str[5];
              var exam_cho4 = str[6];
              var exam_cho5 = str[7];
              // 정답
              var exam_ans = "";
              for (var i = 0; i <= leng; i++) {
                var reg = /[\{\}\[\]\/?.,;:|\)*~`!^\-_+<>@\#$%&\\\=\(\'\"]/gi;
                if (i == 0) {
                  // console.log(str[8 + i]);
                  exam_ans += str[8 + i].replace(reg, "") + ",";
                } else if (i == leng) {
                  exam_ans += str[8 + i].replace(reg, "");
                } else {
                  exam_ans += str[8 + i] + ",";
                }
              }
              // console.log("정답:" + exam_ans);
              // 배점
              var exam_score = str[9 + leng];
              // 난이도
              var exam_level = str[10 + leng];
              // 복수정답 여부
              var exam_mult = str[11 + leng];
              // 힌트 여부
              var exam_hint = str[12 + leng];
              // 전술 ID
              var exam_tac = str[13 + leng];
              // 매트릭스 ID
              var exam_matrix = str[14 + leng];

              // console.log("한줄 읽기:" + lines[line]);
              // ajax TN_TRAIN_EXAM update
              var jsonData = {
                tr_exam_grpid: grpid,
                tr_exam_type: exam_type,
                tr_exam_num: exam_num,
                tr_exam_cont: exam_cont,
                tr_exam_choice_1: exam_cho1,
                tr_exam_choice_2: exam_cho2,
                tr_exam_choice_3: exam_cho3,
                tr_exam_choice_4: exam_cho4,
                tr_exam_choice_5: exam_cho5,
                tr_exam_ans: exam_ans,
                tr_exam_point: exam_score,
                tr_exam_level: exam_level,
                tr_exam_mult_ans: exam_mult,
                tr_exam_hint_flg: exam_hint,
                ma_tactics_id: exam_tac,
                ma_matrix_id: exam_matrix,
              };
              // console.log(jsonData);
              $.ajax({
                url: "http://192.168.32.44:8080/admin/exam_update_csv",
                type: "PATCH",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(jsonData),
                success: function (response) {},
              });
            } else {
              // console.log("미포함");
              var str = lines[line].split(",");
              // console.log(str);
              // 문제 번호
              var exam_num = str[0];
              // 문제 유형
              var exam_type = str[1];
              // 문제 내용
              var exam_cont = str[2];
              // 객관식_번호
              var exam_cho1 = str[3];
              var exam_cho2 = str[4];
              var exam_cho3 = str[5];
              var exam_cho4 = str[6];
              var exam_cho5 = str[7];
              // 정답
              var exam_ans = str[8];
              // 배점
              var exam_score = str[9];
              // 난이도
              var exam_level = str[10];
              // 복수정답 여부
              var exam_mult = str[11];
              // 힌트 여부
              var exam_hint = str[12];
              // 전술 ID
              var exam_tac = str[13];
              // 매트릭스 ID
              var exam_matrix = str[14];

              // console.log("한줄 읽기:" + lines[line]);
              // ajax TN_TRAIN_EXAM update
              var jsonData = {
                tr_exam_grpid: grpid,
                tr_exam_type: exam_type,
                tr_exam_num: exam_num,
                tr_exam_cont: exam_cont,
                tr_exam_choice_1: exam_cho1,
                tr_exam_choice_2: exam_cho2,
                tr_exam_choice_3: exam_cho3,
                tr_exam_choice_4: exam_cho4,
                tr_exam_choice_5: exam_cho5,
                tr_exam_ans: exam_ans,
                tr_exam_point: exam_score,
                tr_exam_level: exam_level,
                tr_exam_mult_ans: exam_mult,
                tr_exam_hint_flg: exam_hint,
                ma_tactics_id: exam_tac,
                ma_matrix_id: exam_matrix,
              };
              // console.log(jsonData);
              $.ajax({
                url: "http://192.168.32.44:8080/admin/exam_update_csv",
                type: "PATCH",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(jsonData),
                success: function (response) {
                  count++;
                  if (count == 1) {
                    alert("문제를 업로드 하였습니다");
                  }
                },
              });
            }
          }
        };
        // console.log(file);
        reader.readAsText(file, "euc-kr");
        $(".popup_exam").toggle();
        $(".back").toggle();
        scrollPlay();
      }
      // location.reload();
    }
  </script>
</html>
